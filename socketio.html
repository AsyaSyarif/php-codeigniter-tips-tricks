<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Simple chat</title>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            /*var socket = io.connect('http://nodejs-box-19648.apne1.actionbox.io:8080');
             socket.on('news', function (data) {
             console.log(data);
             socket.emit('my other event', { my: 'data' });
             });*/
        </script>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
        <script>
            var socket = io.connect('http://nodejs-box-19648.apne1.actionbox.io:8080');

            // on connection to server, ask for user's name with an anonymous callback
            socket.on('connect', function() {
                // call the server-side function 'adduser' and send one parameter (value of prompt)
                socket.emit('adduser', prompt("What's your name?"));
            });
            // listener, whenever the server emits 'updatechat', this updates the chat body
            socket.on('updatechat', function(username, data) {
                $('#conversation').append('<b>' + username + ':</b> ' + data + '<br>');
            });
            
            socket.on('loadmessage', function(messages) {
                for (i in messages) {
                    $('#conversation').append('<b>' + messages[i].username + ':</b> ' + messages[i].data + '<br>');
                }
            });

            // listener, whenever the server emits 'updateusers', this updates the username list
            socket.on('updateusers', function(data) {
                $('#users').empty();
                $.each(data, function(key, value) {
                    $('#users').append('<div>' + key + '</div>');
                });
            });

            // on load of page
            $(function() {
                // when the client clicks SEND
                $('#datasend').click(function() {
                    var message = $('#data').val();
                    $('#data').val('');
                    // tell server to execute 'sendchat' and send along one parameter
                    socket.emit('sendchat', message);
                });

                // when the client hits ENTER on their keyboard
                $('#data').keypress(function(e) {
                    if (e.which == 13) {
                        $(this).blur();
                        $('#datasend').focus().click();
                    }
                });
            });
            //http://psitsmike.com/2011/09/node-js-and-socket-io-chat-tutorial
            //http://psitsmike.com/2011/10/node-js-and-socket-io-multiroom-chat-tutorial
            //http://net.tutsplus.com/tutorials/javascript-ajax/real-time-chat-with-nodejs-socket-io-and-expressjs/
            //http://socket.io/#how-to-use
            //http://davidwalsh.name/websocket
            //http://www.stoimen.com/blog/2010/12/02/diving-into-node-js-a-long-polling-example
            //http://www.contentwithstyle.co.uk/content/long-polling-example-with-nodejs/
            //http://book.mixu.net/ch3.html
            //http://stackoverflow.com/questions/13329129/nodejs-long-polling-pushing-rejeverse-ajax-what-do-i-need-to-push-live-data-i
            //https://go-left.com/blog/programming/long-polling-with-node-js/
            //http://www.gianlucaguarini.com/blog/nodejs-and-a-simple-push-notification-server/
            // end
        </script>
    </head>
    <body>
        <div style="float:left;width:100px;border-right:1px solid black;height:300px;padding:10px;overflow:scroll-y;">
            <b>USERS</b>
            <div id="users"></div>
        </div>
        <div style="float:left;width:300px;height:250px;overflow:scroll-y;padding:10px;">
            <div id="conversation"></div>
            <input id="data" style="width:200px;" />
            <input type="button" id="datasend" value="send" />
        </div>
    </body>
</html>
